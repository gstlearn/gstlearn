---
title: "Kriging with gstlearn"
author: "gstlearn Team"
fontsize: 8pt
output:
  beamer_presentation:
    colortheme: beaver
    theme: Boadilla
  ioslides_presentation: default
theme: Boadilla
colortheme: beaver
---

```{r setup,include=FALSE, fig.show='hide'}
knitr::opts_chunk$set(fig.width=4, fig.height=4, 
                      out.width="50%",
                      fig.align = "center") 
```


\frametitle{Preamble}

In this preamble, we load the **gstlearn** library, clean the workspace.

```{r loading_library, message=FALSE}
rm(list=ls())
library(gstlearn)
library(ggplot2)
library(ggpubr)
```

Then we download the data base **dat**.

```{r Loading_Data}
fileNF = file.path(Sys.getenv('GSTLEARN_DATA'),"Scotland","Scotland_Temperatures.NF")
dat = Db_createFromNF(fileNF)
```

Calculate the experimental variogram **vario2dir** (in 2 directions)

```{r Preamble,message=FALSE, fig.show='hide'}
varioParamMulti = VarioParam_createMultiple(ndir=2, npas=15, dpas=15.)
vario2dir = Vario(varioParamMulti, dat)
err = vario2dir$compute()
```

---

\frametitle{Experimental Variogram and fitted Model}

Calculate the fitted model **fitmodOK** (add the Universality Condition)

```{r Fitting_Model}
fitmodOK = Model()
types = ECov_fromKeys(c("NUGGET","EXPONENTIAL","GAUSSIAN"))
err = fitmodOK$fit(vario2dir,types=types)
err = fitmodOK$addDrift(Drift1())
ggplot() + plot.varmod(vario2dir, fitmodOK)
```

---

\frametitle{Preparing the Environment}

Define the Unique Neighborhood **unique.neigh**:

```{r Neighborhood}
unique.neigh = NeighUnique()
```

Get the extension of the Data:

```{r Statistics_on_Data}
dat$getExtremas()
```

---

\frametitle{Creating the Grid}

Create the Target file **grid**:

```{r Creating_Grid}
grid = DbGrid_create(x0=c(65,535),dx=c(4.94, 4.96),nx=c(81,137))
dbfmt = DbStringFormat_createFromFlags(flag_resume=FALSE, flag_vars=TRUE,
                                       flag_extend=TRUE, flag_stats=FALSE,
                                       flag_array=FALSE)
grid$display(dbfmt)
```


---

\frametitle{Ordinary Kriging}

```{r Ordinary_Kriging}
err = kriging(dbin=dat, dbout=grid, model=fitmodOK, neighparam=unique.neigh,
              flag_est=TRUE, flag_std=TRUE, flag_varz=FALSE,
              namconv=NamingConvention("OK"))
```

---

\frametitle{Ordinary Kriging Estimation}

```{r Plot_Ordinary_Kriging}
p = ggDefaultGeographic()
p = p + plot.grid(grid, legend.name.raster="°C", zlim=c(0,8))
p = p + plot.decoration(title="Ordinary Kriging over whole Grid")
ggPrint(p)
```

---

\frametitle{Reading the Elevation Grid}
  
```{r}
fileNF = file.path(Sys.getenv('GSTLEARN_DATA'),"Scotland","Scotland_Elevations.NF")
grid = DbGrid_createFromNF(fileNF)
grid$display(dbfmt)
```

---

\frametitle{Ordinary Kriging with selection}

The output grid now contains the selection **inshore**. 
Estimation is restricted to the active cells only.

```{r Ordinary_Kriging_with_Selection}
err = kriging(dbin=dat, dbout=grid, model=fitmodOK, neighparam=unique.neigh,
              flag_est=TRUE, flag_std=TRUE, flag_varz=FALSE,
              namconv=NamingConvention("OK"))
```

---

\frametitle{Ordinary Kriging - Estimation}

```{r Ordinary_Kriging_Estimation}
p = ggDefaultGeographic()
p = p + plot.grid(grid, "OK*estim", legend.name.raster="°C", zlim=c(0.,8.))
p = p + plot.point(dat,name_size="January_temp",sizmax=3,color='black')
p = p + plot.decoration(title="Estimation by Ordinary Kriging")
ggPrint(p)
```

---

\frametitle{Ordinary Kriging - Standard Deviation}

```{r Ordinary_Kriging_St_Dev}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"OK*stdev", legend.name.raster="°C", zlim=c(0.,1.))
p = p + plot.point(dat,name_size="January_temp",sizmax=3,color='black')
p = p + plot.decoration(title="St. dev. by Ordinary Kriging")
ggPrint(p)
```

--- 

\frametitle{Transforming the Model}

The Model **fitmodOK** is first duplicated into **fitmodSK**. Then the Universality Condition is deleted.

```{r Model_for_simple_kriging}
fitmodSK = fitmodOK$clone()
err = fitmodSK$delDrift(rank=0)
err = fitmodSK$setMean(mean=20.)
```

Simple Kriging is performed

```{r Simple_Kriging}
err = kriging(dbin=dat, dbout=grid, model=fitmodSK, neighparam=unique.neigh,
              flag_est=TRUE, flag_std=TRUE, 
              namconv=NamingConvention("SK"))
```

--- 

\frametitle{Simple kriging - Estimation}

```{r Simple_Kriging_Estimation}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"SK*estim",legend.name.raster="°C", zlim=c(0.,8.))
p = p + plot.point(dat,name_size="January_temp",sizmax=3,color='black')
p = p + plot.decoration(title="Estimation by Simple Kriging")
ggPrint(p)
```

---

\frametitle{Simple kriging - Standard Deviation}

```{r Simple_Kriging_St_Dev}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"SK*stdev",legend.name.raster="°C", zlim=c(0.,1.))
p = p + plot.point(dat,name_size="January_temp",sizmax=3,color='black')
p = p + plot.decoration(title="St. dev. by Simple Kriging")
ggPrint(p)
```

---

\frametitle{Comparing Ordinary and Simple Kriging - Estimations}

```{r Comparing_Ordinary_and_Simple_Kriging_Estimations,results="hide"}
p = ggplot()
p = p + plot.correlation(grid,name1="OK*estim",name2="SK*estim", 
                     flagRegr=TRUE, flagSameAxes=TRUE, bins=100)
p = p + plot.decoration(title="Estimation Simple vs. Ordinary", 
                    xlab="Ordinary Kriging", ylab="Simple Kriging")
ggPrint(p)
```

---

\frametitle{Comparing Ordinary and Simple Kriging - St. dev.}

```{r Comparing_Ordinary_and_Simple_Kriging_StDev,results="hide"}
p = ggplot()
p = p + plot.correlation(grid,name1 = "OK*stdev",name2="SK*stdev", 
                     flagRegr=TRUE, flagSameAxes=TRUE, bins=100)
p = p + plot.decoration(title="St. dev. Simple vs. Ordinary", 
                    xlab="Ordinary Kriging", ylab="Simple Kriging")
ggPrint(p)
```

---

\frametitle{Cross-validation}


```{r Cross_Validation}
err = xvalid(db=dat, model=fitmodOK, neighparam=unique.neigh, 
             flag_xvalid_est=1, flag_xvalid_std=1,  
             namconv=NamingConvention_create("Xvalid", flag_locator = FALSE))
```

---

\frametitle{Cross-validation - Histogram of Errors}

```{r Cross_Validation_Errors}
p = ggplot()
p = p + plot.hist(dat,name="*esterr*",bins=30,fill="blue")
p = p + plot.decoration(xlab="Estimation Errors", title="Cross-Validation")
ggPrint(p)
```
 
---
 
\frametitle{Cross-validation - Histogram of Standardized Errors}

```{r}
p = ggplot()
p = p + plot.hist(dat,name="*stderr*",bins=30,fill="blue")
p = p + plot.decoration(xlab="Standardized Errors", title="Cross-Validation")
ggPrint(p)
```

---
 
\frametitle{Cross-validation Scores}

```{r}
mean(dat$getColumn("*esterr*"),na.rm=TRUE)
mean(dat$getColumn("*esterr*")^2,na.rm=TRUE)
mean(dat$getColumn("*stderr*")^2,na.rm=TRUE)
```

---

\frametitle{Cross-validation}

```{r Cross_Validation_Errors_Display}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"inshore")
p = p + plot.point(dat,name_size="*esterr",sizmax=3)
p = p + plot.decoration(title="Cross-Validation scores")
ggPrint(p)
```

---

\frametitle{Cross-validation}

```{r Cross_Validation_Absolute_Error}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"inshore")
p = p + plot.point(dat,name_size="*esterr",sizmax=3,flagAbsSize=TRUE)
p = p + plot.decoration(title="Cross-Validation scores (abs. value)")
ggPrint(p)
```

---

\frametitle{Ordinary Kriging}

We design a small Moving Neighborhood **small.neigh** with only 1 sample per neighborhood.

```{r}
small.neigh = NeighMoving_create(nmini=1, nmaxi=1, radius=1000000)
```

We perform Ordinary Kriging 

```{r Ordinary_Kriging_Small_Moving_Neighborhood}
err = kriging(dbin=dat, dbout=grid, model=fitmodOK, neighparam=small.neigh,
              flag_est=TRUE, flag_std=TRUE, 
              namconv=NamingConvention("Small"))
```

---

\frametitle{Ordinary Kriging (Moving Neighborhood)}


```{r Ordinary_Kriging_Small_Moving_Neighborhood_Estimation}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"Small*estim",zlim=c(0.,8.), legend.name.raster="°C")
p = p + plot.point(dat,name_size="January_temp")
p = p + plot.decoration(title="Estimation by Ordinary Kriging (Small Neigh.)")
ggPrint(p)
```

---

\frametitle{Ordinary Kriging (Moving Neighborhood 1)}

Building a reasonable Moving Neighborhood, although with a limited extension (*radius*)

```{r Reduced_Moving_Neighborhood}
moving.neigh = NeighMoving_create(nmini=1, nmaxi=10, radius=20)
```

Running the Ordinary Kriging

```{r Ordinary_Kriging_Large_Moving_Neighborhood}
err = kriging(dat,grid,fitmodOK,moving.neigh,
              flag_est=TRUE, flag_std=TRUE, 
              namconv=NamingConvention("Reduced"))
```

---

\frametitle{Ordinary Kriging (Moving Neighborhood 1)}

```{r Ordinary_Kriging_Large_Moving_Neighborhood_Estimation}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"Reduced*estim", zlim=c(0.,8.), legend.name.raster="°C")
p = p + plot.point(dat,name_size="January_temp")
p = p + plot.decoration(title="Estimation by Ordinary Kriging (Reduced Moving Neigh.)")
ggPrint(p)
```

Lots of target sites are not estimated as no sample is found within the neighborhood.

---

\frametitle{Ordinary Kriging (Moving Neighborhood 2)}

Building a reasonable Moving Neighborhood correctly tuned: 10 samples (maximum) selected in a radius of 150 around the target site.

```{r Large_Moving_Neighborhood}
moving.neigh = NeighMoving_create(nmini=1, nmaxi=10, radius=150)
```

Running the Ordinary Kriging

```{r Ordinary_Kriging_Moving_Neighborhood}
err = kriging(dat,grid,fitmodOK,moving.neigh,
              flag_est=TRUE, flag_std=TRUE, 
              namconv=NamingConvention("Moving"))
```

---

\frametitle{Ordinary Kriging (Moving Neighborhood 2)}

```{r Ordinary_Kriging_Moving_Neighborhood_Estimation}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"Moving*estim",zlim=c(0.,8.), legend.name.raster="°C")
p = p + plot.point(dat,name_size="January_temp")
p = p + plot.decoration(title="Estimation by Ordinary Kriging (Moving Neigh.)")
ggPrint(p)
```

---

\frametitle{Ordinary Kriging (Moving Neighborhood 2)}

```{r Ordinary_Kriging_Moving_Neighborhood_stdev}
p = ggDefaultGeographic()
p = p + plot.grid(grid,"Moving*stdev", zlim=c(0.,1.), legend.name.raster="°C")
p = p + plot.point(dat,name_size="January_temp")
p = p + plot.decoration(title="St. dev. by Ordinary Kriging (Moving Neigh.)")
ggPrint(p)
```

---

\frametitle{Comparing Unique and Moving Neighborhoods}

```{r Comparing_unique_moving_estimation}
p = ggplot()
p = p + plot.correlation(grid,name1 = "OK*estim",name2="Moving*estim", 
                         bins=100, flagDiag=TRUE)
p = p + plot.decoration(title="Ordinary Kriging Estimation", 
                    xlab="Unique", ylab="Moving")
ggPrint(p)
```

---

\frametitle{Comparing Unique and Moving Neighborhoods}

```{r Comparing_unique_moving_stdev}
p = ggplot()
p = p + plot.correlation(grid,name1 = "OK*stdev",name2="Moving*stdev", 
                         bins=100, flagDiag=TRUE)
p = p + plot.decoration(title="Ordinary Kriging St. Dev.", 
                    xlab="Unique", ylab="Moving")
ggPrint(p)
```
