---
title: "Gaussian simulations"
author: "gstlearn Team"
date: "February 2023"
output:
  beamer_presentation:
    colortheme: beaver
    fig_height: 6
    theme: Boadilla
theme: Boadilla
colortheme: beaver
fontsize: 8pt
---

```{r setup,include=FALSE, fig.show='hide'}
knitr::opts_chunk$set(fig.width=4, fig.height=4, 
                      out.width="50%",
                      fig.align = "center") 
```

\frametitle{Preamble}

```{r loading_library, message=FALSE}
rm(list=ls())
library(gstlearn)
library(ggplot2)
library(ggpubr)
```


```{r Preamble, message=FALSE}
fileNF = file.path(Sys.getenv('GSTLEARN_DATA'),"Scotland","Scotland_Temperatures.NF")
dat = Db_createFromNF(fileNF)
fileNF = file.path(Sys.getenv('GSTLEARN_DATA'),"Scotland","Scotland_Elevations.NF")
target = DbGrid_createFromNF(fileNF)

neighU = NeighUnique_create()

ndim = 2
defineDefaultSpace(ESpaceType_RN(), ndim)
```

We calculate the experimental directional variogram and fit the Model

```{r Fitting_the_Model}
varioparam = VarioParam_createOmniDirection(npas=40, dpas=10)
vario_raw2dir = Vario_create(varioparam, dat)
err = vario_raw2dir$compute()

fitmod = Model()
err = fitmod$fit(vario_raw2dir, 
                 types=ECov_fromKeys(c("NUGGET", "SPHERICAL", "CUBIC")))
fitmod$display()
```

---

\frametitle{Unconditional simulation}

Use the Turning Bands method with 1 band

```{r Unconditional_Simulation_with_1_band}
err = simtub(dbout=target, model=fitmod, nbtuba=1, seed=12454,
             namconv=NamingConvention("Simu1"))
p = ggDefault(2)
p = p + plot(target, "Simu1")
p = p + plot.decoration(title="Simulation with 1 band")
ggPrint(p)
target$display()
```

---

\frametitle{Unconditional simulation}

Use the Turning Bands method with 10 bands

```{r Unconditional_Simulation_with_10_bands} 
err = simtub(dbout=target, model=fitmod, nbtuba=10, seed=12454,
             namconv=NamingConvention("Simu10"))
p = ggDefault(2)
p = p + plot(target, "Simu10")
p = p + plot.decoration(title="Simulation with 10 Turning Bands")
ggPrint(p)
target$display()
```

---

\frametitle{Unconditional simulation}

Use the Turning Bands method with 1000 bands

```{r Unconditional_Simulation_with_1000_bands}
err = simtub(dbout=target, model=fitmod, nbtuba=1000, seed=12454,
             namconv=NamingConvention("Simu1000"))
p = ggDefault(2)
p = p + plot(target,"Simu1000")
p = p + plot.decoration(title="Simulation with 1000 Turning Bands")
ggPrint(p)
target$display()
```

---

\frametitle{Conditional simulations}

Perform 10 conditional simulations with 1000 bands

```{r Conditional_Simulation_Parameters}
nbsimu = 10
nbtuba = 1000
seed   = 13231
```

Simulations with Simple Kriging (Mean is extracted from the Data)

```{r Perform_Conditional_Simulations}
mean_Temperature = dbStatisticsMono(dat, c("J*temp"), 
                                    EStatOption_fromKeys(c("MEAN")))
print(mean_Temperature)
err = fitmod$setMeans(mean_Temperature)

err = simtub(dat, target, model=fitmod, neighparam=neighU, nbsimu=nbsimu,
             nbtuba=nbtuba, seed=seed)
target$display()
```

---

\frametitle{Display several Simulation Outcomes}


```{r One_Simulation_Outcome}
p1 = ggDefault(2)
p1 = p1 + plot(target, "Simu*temp.1")
p1 = p1 + plot(dat, flagCst=TRUE)
p2 = ggDefault(2)
p2 = p2 + plot(target, "Simu*temp.2")
p2 = p2 + plot(dat, flagCst=TRUE)
p3 = ggDefault(2)
p3 = p3 + plot(target, "Simu*temp.3")
p3 = p3 + plot(dat, flagCst=TRUE)
p4 = ggDefault(2)
p4 = p4 + plot(target, "Simu*temp.4")
p4 = p4 + plot(dat, flagCst=TRUE)
ggarrange(p1,p2,p3,p4,nrow=2,ncol=2)
```

---

\frametitle{Comparing Mean of Simulations with the Kriging}

```{r Comparing_Mean_of_Simulations_with_the_Kriging, results="hide"}
err = target$statistics(c("Simu.January_temp*"), 
                        EStatOption_fromKeys(c("MEAN")),
                        flagStoreInDb=TRUE)

err = kriging(dat, target, model=fitmod, neighparam = neighU,
              namconv=NamingConvention("KS"))

p = ggplot()
p = p + plot.correlation(target, "Stats.MEAN", "KS*estim", flagDiag=TRUE, bins=100)
p = p + plot.decoration(xlab="Mean of Simulations", ylab="Simple Kriging Estimate")
ggPrint(p)
target$display()
```

---

\frametitle{Simulations with External Drift}

We perform the following steps:

* Load the grid containing the Elevation Map
* Prepare the Data Base: designation of External Drift
* Fit the Model of the Residuals

```{r Preparing_External_Drift}

fileNF = file.path(Sys.getenv('GSTLEARN_DATA'),"Scotland","Scotland_Temperatures.NF")
dat = Db_createFromNF(fileNF)
dat$setLocator("Elevation", ELoc_F())

fileNF = file.path(Sys.getenv('GSTLEARN_DATA'),"Scotland","Scotland_Elevations.NF")
target = DbGrid_createFromNF(fileNF)
target$setLocator("Elevation", ELoc_F())

vario_resED = Vario_create(varioparam, dat)
model = Model()
err = model$setDriftIRF(nfex = 1)
err = vario_resED$compute(model=model)
vario_resED$display()

model_ED = Model()
err = model_ED$fit(vario_resED, 
                   types=ECov_fromKeys(c("SPHERICAL","CUBIC")))
err = model_ED$setDriftIRF(nfex=1)
model_ED$display()
```

```{r}
ggplot() + plot.varmod(vario_resED, model_ED)
```

---

\frametitle{Simulations with External Drift}

```{r Simulations_with_External_Drift}
err = simtub(dat, target, model=model_ED, neighparam=neighU, nbsimu=nbsimu,
             nbtuba=nbtuba, seed=seed)
```

```{r}
p1 = ggDefault(2) + plot(target, "Simu*temp.1")
p2 = ggDefault(2) + plot(target, "Simu*temp.2")
p3 = ggDefault(2) + plot(target, "Simu*temp.3")
p4 = ggDefault(2) + plot(target, "Simu*temp.4")
ggarrange(p1,p2,p3,p4,ncol=2,nrow=2)
```

---

\frametitle{Comparing Mean of Simulations and Kriging with External Drift}

```{r Comparing_Mean_of_Simulations_with_the_Kriging-2, results="hide"}
err = target$statistics(c("Simu.January_temp*"), 
                        EStatOption_fromKeys(c("MEAN")),
                        flagStoreInDb=TRUE)

err = kriging(dat, target, model=model_ED, neighparam = neighU,
              namconv=NamingConvention("KED"))

p = ggplot()
p = p + plot.correlation(target, "Stats.MEAN", "KED*estim", flagDiag=TRUE,
                     bins=100)
p = p + plot.decoration(xlab="Mean of Simulations", 
                ylab="Kriging with External Drift")
ggPrint(p)
target$display()
```

\frametitle{Deriving probability to exceed a Cutoff}

```{r Deriving_probability_to_exceed_Cutoff}
target["Simu.January_temp*"] = target["Simu.January_temp*"] > 0

err = target$statistics(c("Simu.January_temp*"), 
                        EStatOption_fromKeys(c("MEAN")), 
                        flagStoreInDb=TRUE,
                        namconv=NamingConvention("Proba"))

p = ggDefault(2)
p = p + plot(target, "Proba.MEAN", show.legend.raster=TRUE, legend.name.raster="Probability")
p = p + plot.decoration(title="Probability for positive Temperatures")
ggPrint(p)
target$display()
```

