---
title: "gstlearn"
author: "Didier RENARD,  Nicolas DESASSIS"
output:
  html_document:
    df_print: paged
---

```{r, include=FALSE}
## Global options for code chunks
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.width = 6,
  warning = FALSE
)
```

### Introduction

The **gstlearn** R package is a cross-platform R package wrapping the [gstlearn C++ Library](https://gstlearn.org). It offers to R users **all famous Geostatistical methodologies** developed and/or invented by the Geostatistic Team of the [Geosciences Research Center](https://www.geosciences.minesparis.psl.eu/)! It is the successor of the [RGeostats R package](http://cg.ensmp.fr/rgeostats).

To install the **gstlearn** R Package, you need R 4.2 (or higher). You can then execute the following R command:
```{r }
install.packages("gstlearn",repos="https://soft.mines-paristech.fr/cran")
```

#### About C++ & R

The *gstlearn* R package is generated using a particular version of SWIG (see below). As a R user, you probably know more about Rcpp package. We have chosen SWIG in order to mutualize the wrapper code of *gstlearn* C++ library for several different target languages.

The classes and functions documentation is provided with the *gstlearn* C++ library as html files generated by Doxygen. Please, refer to *gstlearn* C++ library [README file](https://github.com/gstlearn/gstlearn) for more details. Only the *public* methods are exported by SWIG and must be considered in the R package.

Their is currently no R documentation for the *gstlearn* R package. The user can refer to the C++ documentation and have to learn how to adapt the code into R language following these "conversion rules":

* C++ classes are automatically converted into S4 classes. After creating an instance of an S4 class, methods (i.e. class function) must be called using `$` slot applied to the instance (i.e. an object) of that class (see `addColumns` in the example above which is a method of the class `Db`).

* If you ask for the class type of a *gstlearn* object under R (e.g. `class(mygrid)`), you will obtain the C++ class name prefixed with '_p_' (e.g. `_p_DbGrid`).

* Static C++ methods (e.g. `createFromNF` method in `DbGrid` class) defined in a class (e.g. `DbGrid`) are renamed by joining the class name and the method name (e.g. `DbGrid_createFromNF'`). Note: Static methods do not apply to object instances (e.g. `mygrid$createFromNF()` has no sense)

* Static C++ variables (e.g. `X` locator) defined in a class (e.g. `ELoc` 'enum' class) must be accessed in R using special functions named following the same rules as static methods (e.g. `ELoc_X()` in example above)

* All basic C++ types (`double`, `int`, `bool`, etc...) are automatically converted to/from R native types (`numeric`, `integer`, `logical`,...) (e.g. see `var` variable in the example above)

* The C++ classes `VectorDouble`, `VectorInt`, etc...  are automatically converted to/from R vectors (e.g. `c(1,2,3)`)

* The C++ classes `VectorVectorDouble`, `VectorVectorInt`, etc...  are automatically converted to/from lists of R vectors (e.g. `list(c(1,2,3), c(4,5,6))`)

* Some classes of the *gstlearn* C++ library have been extended in R:
  * Almost all classes are 'stringable' (those which inherit from `AStringable`), that means that you can type the object name in the R console prompt and hit 'Enter' key to obtain a detailed description of the object content. The same output text is obtained using the `display` method (e.g. `mygrid$display()`)
  * Some classes have an additional R method named `toTL` (i.e. 'to Target Language') that permits to convert an object into the corresponding R type. For example, the instruction `df = mygrid$toTL()` permits to create a R `data.frame` from a `Db` object. In that case, the newly created `data.frame` will contain all variables from the Db (but locators and grid parameters (for DbGrid) wlll be lost)

		
### Loading the  package

```{r setup, message=FALSE}
library(gstlearn)
library(ggplot2)
```

### First code: Create and display a database

```{r Create-and-display-the-grid}
db = DbGrid_create(nx=c(100,100))
model = Model_createFromParam(type = ECov_CUBIC(), range = 30)
err = simtub(NULL, db, model, nbtuba=1000)
p = ggplot()
p = p + plot(db, "Simu")
p = p + plot.decoration(title="Check is successful!")
ggPrint(p)
db$display()
```


### RGeostats to gstlearn

For people who were using [RGeostats](http://cg.ensmp.fr/rgeostats), here is the description of some new concepts introduced in *gstlearn*. We are currently working hard to improve the user experience. Some of the following differences are drawbacks that will be fixed in a close future.

* The objects manipulated through *gstlearn* R package (Database, Variograms, Polygons, etc...) are now **external pointers*.

* If you need to duplicate your objects, a simple assignment (e.g. `db2 = db1`) is not possible. You must use the `clone` method by doing this: `db2 = db1$clone()`. All classes that inherits from `iCloneable` have this capability.

* The *gstlearn* objects memory content is not stored in the R workspace anymore. This means that saving the R workspace (`.RData`) is dangerous because it stores only memory pointers that won't be valid when loading the workspace in a future R session.

* People who want to recover the objects content for a future R session, have to save them to 'Neutral Files' using `dumpToNF` method before quitting R. All classes that inherits from `ASerializable` have this capability. The following R code explains how to create a 'Neutral File' and load it later:

```{r , eval=FALSE}
# Create a Neutral File storing mygrid content
db$dumpToNF("toto.backup") # This could produce an error - see below
#...
# Restart the R session
#...
# Load the Neutral File and recreate mygrid
db = DbGrid_createFromNF("mygrid.backup")
```

### Known caveats

When executing a method using the `$` slot, if you experience the following error...
```{r ,echo=FALSE}
base::message("Erreur dans validObject(.Object) : 
  objet de classe “MethodWithNext” incorrect: Error : C stack usage  7972404 is too close to the limit")
```

... there are two possible reasons:
* You made a mistake in the method name
* R cannot find the method because it is defined in an inherited class (for example `dumpToNF` is a method from `ASerializable` and currently `mygrid$dumpToNF` produces this error. In that case, you still can use the generic function behind the method by calling:

```{r , eval=FALSE}
ASerializable_dumpToNF(db, "mygrid.backup")
```



